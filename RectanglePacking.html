<html>
<head>
<script>

function randInt( max, min ) {
  if (!min) min = 0
  const r = min + Math.floor(Math.random() * (max - min))
  return r
}

function hardshrink( x, y, eps ) {
  if (eps == undefined) eps = 1e-12
  const d = x - y
  return (Math.abs(d) <= eps)? 0 : d
}

var AspectRatios, Tiles

function generateRandomTiles( N, minAspectRatio, maxAspectRatio ) {
  // aspect ratio = width/height
  if (!minAspectRatio) minAspectRatio = 9/16
  if (!maxAspectRatio) maxAspectRatio = 16/9

  AspectRatios = new Array(N)
  var   Labels = new Array(N)

  for (var i = 0; i < N; i++) {
    var aspectRatio = -1, numerator, denominator
    while (aspectRatio <= minAspectRatio || aspectRatio >= maxAspectRatio) {
      numerator   = randInt(20 +1, 5)
      denominator = randInt(20 +1, 5)
      aspectRatio = numerator / denominator
    }
    AspectRatios[i] = aspectRatio

    for (var k = numerator; k >= 2; k--) {
      if (numerator % k == 0 && denominator % k == 0) { numerator /= k, denominator /= k } }
    Labels[i] = `${i}<br>${numerator}:${denominator}`
  }

// AspectRatios = [9/8, 2/3, 13/10, 13/15, 2/3, 17/13, 3/2, 1/1, 19/12, 3/2]
// AspectRatios = AspectRatios.splice(0, N)
// function round( x, d ) { const precision = 10**d; return Math.round(x *precision)/precision }
// for (var i = 0; i < Labels.length; i++) Labels[i] = `${i}<br>${round(AspectRatios[i], 3)}`

  function createTile( aspectRatio, label ) {
    const tile = document.createElement("div")
    document.body.appendChild(tile)
    tile.innerHTML = `<div class="label">${label}</div>`

    tile.l = tile.r = tile.t = tile.b = 0
    tile.aspectRatio = tile.area = tile.w = aspectRatio
    tile.h = 1
    function update() {
      tile.r = tile.l + tile.w
      tile.b = tile.t + tile.h
      tile.area = tile.w * tile.h
      
      return tile
    }

    const style = tile.style
    var color = '#'; for (var i = 0; i < 3; i++) color += randInt(8).toString(16)
    style.backgroundColor = color

    tile.moveTo = function( x, y ) {
      style.left = tile.l = x
      style.top  = tile.t = y
      return update()
    }
    tile.moveBy = function( x, y ) { return tile.moveTo(tile.l + x, tile.t + y) }
    tile.setWidth = function( w ) {
      style.width  = tile.w = w
      style.height = tile.h = w /aspectRatio
      return update()
    }
    tile.setHeight = function( h ) {
      style.width  = tile.w = h *aspectRatio
      style.height = tile.h = h
      return update()
    }
    tile.scale = function( s ) {
      tile.moveTo(tile.l *s, tile.t *s)
      return tile.setWidth(tile.w *s)
    }

    return tile
  }

  Tiles = new Array(AspectRatios.length)
  for (var i = 0; i < Tiles.length; i++) Tiles[i] = createTile(AspectRatios[i], Labels[i])
}

function centerTiles() {
  var left = Infinity, right  = -Infinity,
      top  = Infinity, bottom = -Infinity

  for (var i = 0; i < Tiles.length; i++) {
    var tile = Tiles[i]

    if (left   > tile.l)   left = tile.l
    if (right  < tile.r)  right = tile.r
    if (top    > tile.t)    top = tile.t
    if (bottom < tile.b) bottom = tile.b
  }

  const sw = document.body.offsetWidth  / (right - left),
        sh = document.body.offsetHeight / (bottom - top)
  const s = ((sw < sh)? sw : sh)
  const dx = (document.body.offsetWidth  - (right + left) *s)/2,
        dy = (document.body.offsetHeight - (bottom + top) *s)/2

  for (var i = 0; i < Tiles.length; i++) { const tile = Tiles[i]
                                           tile.scale(s); tile.moveBy(dx, dy) }
}

var ron = false
function setRectangularLayout( containerAspectRatio ) {
  const t0 = Tiles[0]
  t0.moveTo(0, 0)

  var box = { l: t0.l, t: t0.t, r: t0.w, b: t0.h,
              w: function() { return this.r - this.l },
              h: function() { return this.b - this.t } }

  var isLeft = !true, isTop = !true, isLeftRight = true

  var i = 1, _i = 0
const HS = hardshrink; hardshrink = function( x, y ) { console.log(i, x, x / y); return HS(x, y) }

  while (i < Tiles.length) {
    const i0 = i

    var l = box.l, w = Tiles[i].w,
        t = box.t, h = Tiles[i].h

    var aspectRatio = box.w() / box.h()
    const s = hardshrink(aspectRatio, containerAspectRatio)
    if (s < 0 || s == 0 && (isLeftRight = !isLeftRight)) {
    // place left/right
console.log("lr")

      aspectRatio = (box.w() + box.h() * w / h) / box.h()
      if (hardshrink(aspectRatio, containerAspectRatio) <= 0) i += 1
      else {
        while (true) {
          if ((i += 1) >= Tiles.length) {
console.log("break lr", aspectRatio, _i)
if (ron) break
            const _tile = Tiles[_i]
            var _w = _tile.w, _h = _tile.h
            for (var j = _i +1; j < i; j++) _w += _h * Tiles[j].w / Tiles[j].h
            _h *= box.w() / _w
            const modifiedRatio = box.w() / (box.h() + _h - _tile.h)
console.log(aspectRatio/containerAspectRatio, containerAspectRatio/modifiedRatio)
            if (aspectRatio/containerAspectRatio > containerAspectRatio/modifiedRatio) break

            l = _tile.l, t = _tile.t
            for (var j = _i; j < i; j++) {
              const tile = Tiles[j]
              tile.setHeight(_h)
              tile.moveTo(l, t)
              l += tile.w
            }
            return
          }

          const dh = w * Tiles[i].h / Tiles[i].w
          aspectRatio = (box.w() + box.h() * w / (h + dh)) / box.h()
          if (hardshrink(aspectRatio, containerAspectRatio) < 0) break
          h += dh
        }
      }
      w *= box.h() / h

      if (isLeft = !!isLeft) { l -= w, box.l -= w }
      else               { l = box.r; box.r += w }

      _i = i0
      for (var j = _i; j < i; j++) {
        const tile = Tiles[j]
        tile.setWidth(w)
        tile.moveTo(l, t)
        t += tile.h
      }
    }
    else {
    // place top/bottom
console.log("tb")

      aspectRatio = box.w() / (box.w() * h / w + box.h())
      if (hardshrink(aspectRatio, containerAspectRatio) >= 0) i += 1
      else {
        while (true) {
          if ((i += 1) >= Tiles.length) {
console.log("break tb", aspectRatio, _i)
if (ron) break
            const _tile = Tiles[_i]
            var _w = _tile.w, _h = _tile.h
            for (var j = _i +1; j < i; j++) _h += _w * Tiles[j].h / Tiles[j].w
            _w *= box.h() / _h
            const modifiedRatio = (box.w() + _w - _tile.w) / box.h()
console.log(aspectRatio, modifiedRatio)
            if (aspectRatio/containerAspectRatio > containerAspectRatio/modifiedRatio) break

            l = _tile.l, t = _tile.t
            for (var j = _i; j < i; j++) {
              const tile = Tiles[j]
              tile.setWidth(_w)
              tile.moveTo(l, t)
              t += tile.h
            }
            return
          }

          const dw = h * Tiles[i].w / Tiles[i].h
          aspectRatio = box.w() / (box.w() * h / (w + dw) + box.h())
          if (hardshrink(aspectRatio, containerAspectRatio) > 0) break
          w += dw
        }
      }
      h *= box.w() / w

      if (isTop = !!isTop) { t -= h, box.t -= h }
      else             { t = box.b; box.b += h }

      _i = i0
      for (var j = _i; j < i; j++) {
        const tile = Tiles[j]
        tile.setHeight(h)
        tile.moveTo(l, t)
        l += tile.w
      }
    }
    console.log('')
  }

console.log("aspect", box.w() / box.h())
}

function init() {
  generateRandomTiles(10)
  update()
}

function update() {
  const aspectRatio = 2//document.body.offsetWidth / document.body.offsetHeight
  setRectangularLayout(aspectRatio)
  document.title = `Container Aspect Ratio: ${aspectRatio}`

  centerTiles()
}

</script>
<style>

body {
  margin: 0;
  padding: 0;
}

div {
  position: absolute;
  _border: 1px solid black;
  
  opacity: 0.5;
}

div.label {
  margin: 5px;
  color: white;
  font-size: 10px;
}

</style>
</head>
<body onload="init()" onresize="update()" onclick="update()">
</body>
</html>
