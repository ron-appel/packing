<html>
<head>
<script>
"use strict"

function randInt( m, max ) {
/*
  randInt(max) // min = 0
  randInt(min, max)
  return random int in [min, max] (inclusive)
*/
  if (max == undefined) { max = m; m = 0 }
  return m + Math.floor(Math.random() * (max +1 - m))
}

function hardshrink( x, eps ) {
  if (eps == undefined) eps = 1e-12
  return (Math.abs(x) <= eps)? 0 : x
}

function round( x, d ) {
  if (d == undefined) d = 0
  const precision = 10**d;
  return Math.round(x *precision) /precision
}

function onenter( f ) { if (window.event.key == "Enter") f() }

</script>
<script>
"use strict"

const params = {
  N: "100",
  // aspect-ratio = width/height
  min_ratio: "9/16",
  max_ratio: "16/9",

  get: function( param ) { return Function(`return ${this[param]}`)() }
}

var Tiles
function generate_tiles() {
  if (Tiles == undefined) {
    const  N = params.get('N'),
    min_ratio = params.get("min_ratio"),
    max_ratio = params.get("max_ratio")

    Tiles = new Array(N)
    for (let i = 0; i < Tiles.length; i++) {
      const aspect_ratio = min_ratio + (max_ratio - min_ratio) *Math.random()
      Tiles[i] = aspect_ratio
    }
  }

  function create_tile( aspect_ratio, label ) {
    const div = document.createElement("div")
    document.body.appendChild(div)
    div.innerHTML = `<div class="label">${label}</div>`

    const style = div.style
    var color = '#'; for (let i = 0; i < 3; i++) color += randInt(8).toString(16)
    style.backgroundColor = color

    const tile = { div: div }
    tile.l = tile.t = 0
    tile.b = tile.h = 1
    tile.aspect_ratio = tile.area = tile.r = tile.w = aspect_ratio
    function update() {
      tile.r = tile.l + tile.w
      tile.b = tile.t + tile.h
      tile.area = tile.w * tile.h

      return tile
    }

    tile.move_to = function( x, y ) {
      style.left = tile.l = x
      style.top  = tile.t = y
      return update()
    }
    tile.move_by = function( x, y ) { return tile.move_to(tile.l + x, tile.t + y) }
    tile.set_width = function( w ) {
      style.width  = tile.w = w
      style.height = tile.h = w /aspect_ratio

      return update()
    }
    tile.set_height = function( h ) {
      style.width  = tile.w = h *aspect_ratio
      style.height = tile.h = h
      return update()
    }
    tile.scale = function( s ) {
      tile.move_to(tile.l *s, tile.t *s)
      return tile.set_width(tile.w *s)
    }

    return tile
  }

  var Aspects = '['
  for (let i = 0; i < Tiles.length; i++) {
    let aspect_ratio = Tiles[i]
    let m1, n1, d1 = Infinity
    for (let m = 1; m <= 16; m++) {
      for (let n = 1; n <= 16; n++) {
        const d = Math.abs(m/n - aspect_ratio)
        if (d1 > d) { d1 = d, m1 = m, n1 = n }
      }
    }
    const label = `${i +1}<br>${m1}:${n1}`
    aspect_ratio = m1/n1
    Aspects += `${m1}/${n1}, `

    Tiles[i] = create_tile(aspect_ratio, label)
  }
  console.log(Aspects.slice(0, -2) + ']' + "\n\n")

  return Tiles
}

function center_tiles() {
  var left = Infinity, right  = -Infinity,
      top  = Infinity, bottom = -Infinity

  for (let i = 0; i < Tiles.length; i++) {
    const tile = Tiles[i]
    if (left   > tile.l)   left = tile.l
    if (right  < tile.r)  right = tile.r
    if (top    > tile.t)    top = tile.t
    if (bottom < tile.b) bottom = tile.b
  }

  const sw = window.innerWidth  / (right - left),
        sh = window.innerHeight / (bottom - top)
  const s = ((sw < sh)? sw : sh)
  const dx = (window.innerWidth  - (right + left) *s)/2,
        dy = (window.innerHeight - (bottom + top) *s)/2

  for (let i = 0; i < Tiles.length; i++) { const tile = Tiles[i]
                                           tile.scale(s); tile.move_by(dx, dy) }

  const layout_ratio = (right - left) / (bottom - top)
  return layout_ratio
}

function place_tiles( Batches ) {
  const t0 = Tiles[0]
  t0.move_to(0, 0)

  var i = 1, isLeft = true, isTop = true,
      l = 0, t = 0, r = t0.w, b = t0.h

  for (let k = 2; k <= Batches.length; k++) {
    if (i >= Tiles.length) break

    let w = 0, h = 0, x, y
    const i1 = (k < Batches.length)? Batches[k].i : Tiles.length
    if (Batches[k -1].across) {
      for (let j = i; j < i1; j++) w += Tiles[j].w / Tiles[j].h
      h = (r - l) / w
      x = l
      if (isTop = !isTop) y = (t -= h)
      else             { y = b; b += h }
 
      while (i < i1) {
        const tile = Tiles[i++]
        tile.move_to(x, y)
        tile.set_height(h)
        x += tile.w
      }
    }
    else {
      for (let j = i; j < i1; j++) h += Tiles[j].h / Tiles[j].w
      w = (b - t) / h
      y = t
      if (isLeft = !isLeft) x = (l -= w)
      else               { x = r; r += w }
 
      while (i < i1) {
        const tile = Tiles[i++]
        tile.move_to(x, y)
        tile.set_width(w)
        y += tile.h
      }
    }
  }
}

var can_modify = true
function set_rectangular_layout( frame_ratio ) {
  var W = Tiles[0].w,
      H = Tiles[0].h,
      Batches = [{ i: 0, across: null, w: 0, h: 0 }]
  
  var i = 1, is_across, throttle = 1
  while (i < Tiles.length) {
    // throttle placements
    throttle = throttle *1.25 +1

    var w = Tiles[i].w,
        h = Tiles[i].h,
        aspect_ratio = W / H

    const s = hardshrink(aspect_ratio - frame_ratio)
    is_across = s > 0 || s == 0 && !is_across
    Batches.push({ i: i, across: is_across, w: W, h: H })

    if (is_across) { // place across
      aspect_ratio = H / W + h / w //= 1/(W / (W * h / w + H))
      if (hardshrink(aspect_ratio - 1/frame_ratio) <= 0) i += 1
      else {
        while ((i += 1) < Tiles.length && i < throttle) {
          const dw = h * Tiles[i].w / Tiles[i].h
          aspect_ratio = H / W + h / (w + dw) //= 1/(W / (W * h / (w + dw) + H))
          if (hardshrink(aspect_ratio - 1/frame_ratio) < 0) break
          w += dw
        }
      }
      H += h * W / w
    }
    else { // place downward
      aspect_ratio = W / H + w / h //= (W + H * w / h) / H
      if (hardshrink(aspect_ratio - frame_ratio) <= 0) i += 1
      else {
        while ((i += 1) < Tiles.length && i < throttle) {
          const dh = w * Tiles[i].h / Tiles[i].w
          aspect_ratio = W / H + w / (h + dh) //= (W + H * w / (h + dh)) / H
          if (hardshrink(aspect_ratio - frame_ratio) < 0) break
          h += dh
        }
      }
      W += w * H / h
    }

    if (i >= Tiles.length && can_modify) {
      aspect_ratio = W / H
      while (Batches.length > 1) {
        const batch = Batches[Batches.length -2]
        let modified_ratio
        if (batch.across) {
          let r = 0; for (let j = batch.i; j < Tiles.length; j++) r += Tiles[j].w / Tiles[j].h
          modified_ratio = batch.w / (batch.h + batch.w / r)
        }
        else {
          let r = 0; for (let j = batch.i; j < Tiles.length; j++) r += Tiles[j].h / Tiles[j].w
          modified_ratio = (batch.w + batch.h / r) / batch.h
        }
        const is_modified_worse = Math.abs(  aspect_ratio - frame_ratio) <
                                  Math.abs(modified_ratio - frame_ratio)
        if (is_modified_worse) break
        Batches.pop()
        aspect_ratio = modified_ratio
      }

      break
    }
  }

  place_tiles(Batches)
}

function refresh() {
  for (let param in params) {
    const input = document.getElementById(param)
    if (input) input.value = params[param]
  }

  const obj = document.getElementById("settings")
  while (obj.nextSibling) obj.nextSibling.remove()
  Tiles = undefined

  generate_tiles()
  update()
}

function update() {
  const frame_ratio = window.innerWidth / window.innerHeight
  set_rectangular_layout(frame_ratio)

  const layout_ratio = center_tiles()
  const ratio_error = Math.abs(frame_ratio / layout_ratio -1)
  document.title = `Ratio Error: ${round(ratio_error, 3)}`
console.log("frame", frame_ratio, "layout", layout_ratio, "error", ratio_error)
}

function set_params() {
  for (let param in params) {
    const input = document.getElementById(param)
    if (input && RegExp(input.pattern).test(input.value)) params[param] = input.value
  }
  event.target.blur()

  refresh()
}

</script>
<style>

body {
  margin: 0;
  padding: 0;

  overflow: hidden;
}

div {
  position: absolute;
  opacity: 0.5;
}

#settings {
  border: 1px solid black;
  background-color: white;

  left: 0;
  top: 0;
  z-index: 1;
  width: 12px;
  height: 18px;
  overflow: hidden;

  padding: 2px;
}
#settings span {
  font-size: 18px;
}

#settings:hover {
  opacity: 0.9;

  width: auto;
  height: auto;

  padding: 12px;
}
#settings:hover span {
  display: none;
}


.label {
  margin: 5px;
  color: white;
  font-size: 10px;
}

</style>
</head>
<body onload="refresh()" onresize="update()" onclick="update()" onkeypress="onenter(refresh)">
<div id="settings" onkeypress="onenter(set_params)">
<span>? &nbsp;</span>
Resize window or click to update layout.
<br><br>
number of rectangles: <input type="text" id="N" size="4" pattern="^[0-9]+$" title="Integer">
&nbsp;
<button onclick="refresh()">regenerate</button>
<br>
min-ratio: <input type="text" id="min_ratio" size="6" pattern="^[0-9/.]+$" title="Number or Fraction">
max-ratio: <input type="text" id="max_ratio" size="6" pattern="^[0-9/.]+$" title="Number or Fraction">
</div>
</body>
</html>
