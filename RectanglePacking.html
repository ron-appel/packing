<html>
<head>
<script>
"use strict"

function randInt( m, max ) {
/*
  randInt(max) // min = 0
  randInt(min, max)
  return random int in [min, max] (inclusive)
*/
  if (max == undefined) { max = m; m = 0 }
  return m + Math.floor(Math.random() * (max +1 - m))
}

function hardshrink( x, eps ) {
  if (eps == undefined) eps = 1e-12
  return (Math.abs(x) <= eps)? 0 : x
}

function round( x, d ) {
  if (d == undefined) d = 0
  const precision = 10**d;
  return Math.round(x *precision) /precision
}

function onenter( f ) { if (window.event.key == "Enter") f() }

</script>
<script>
"use strict"

const settings = {
  N: "100",
  // aspect-ratio = width/height
  minRatio: "9/16",
  maxRatio: "16/9",

  get: function( key ) { return Function(`return ${this[key]}`)() }
}

var Tiles
function generateTiles() {
  if (Tiles == undefined) {
    const  N = settings.get('N'),
    minRatio = settings.get("minRatio"),
    maxRatio = settings.get("maxRatio")

    Tiles = new Array(N)
    for (let i = 0; i < Tiles.length; i++) {
      const aspectRatio = minRatio + (maxRatio - minRatio) *Math.random()
      Tiles[i] = aspectRatio
    }
  }

  function createTile( aspectRatio, label ) {
    const div = document.createElement("div")
    document.body.appendChild(div)
    div.innerHTML = `<div class="label">${label}</div>`

    const style = div.style
    var color = '#'; for (let i = 0; i < 3; i++) color += randInt(8).toString(16)
    style.backgroundColor = color

    const tile = { div: div }
    tile.l = tile.t = 0
    tile.b = tile.h = 1
    tile.aspectRatio = tile.area = tile.r = tile.w = aspectRatio
    function update() {
      tile.r = tile.l + tile.w
      tile.b = tile.t + tile.h
      tile.area = tile.w * tile.h

      return tile
    }

    tile.moveTo = function( x, y ) {
      style.left = tile.l = x
      style.top  = tile.t = y
      return update()
    }
    tile.moveBy = function( x, y ) { return tile.moveTo(tile.l + x, tile.t + y) }
    tile.setWidth = function( w ) {
      style.width  = tile.w = w
      style.height = tile.h = w /aspectRatio

      return update()
    }
    tile.setHeight = function( h ) {
      style.width  = tile.w = h *aspectRatio
      style.height = tile.h = h
      return update()
    }
    tile.scale = function( s ) {
      tile.moveTo(tile.l *s, tile.t *s)
      return tile.setWidth(tile.w *s)
    }

    return tile
  }

  var Aspects = '['
  for (let i = 0; i < Tiles.length; i++) {
    let aspectRatio = Tiles[i]
    let m1, n1, d1 = Infinity
    for (let m = 1; m <= 16; m++) {
      for (let n = 1; n <= 16; n++) {
        const d = Math.abs(m/n - aspectRatio)
        if (d1 > d) { d1 = d, m1 = m, n1 = n }
      }
    }
    const label = `${i +1}<br>${m1}:${n1}`
    aspectRatio = m1/n1
    Aspects += `${m1}/${n1}, `

    Tiles[i] = createTile(aspectRatio, label)
  }
  console.log(Aspects.slice(0, -2) + ']' + "\n\n")

  return Tiles
}

function centerTiles() {
  var left = Infinity, right  = -Infinity,
      top  = Infinity, bottom = -Infinity

  for (let i = 0; i < Tiles.length; i++) {
    const tile = Tiles[i]
    if (left   > tile.l)   left = tile.l
    if (right  < tile.r)  right = tile.r
    if (top    > tile.t)    top = tile.t
    if (bottom < tile.b) bottom = tile.b
  }

  const sw = window.innerWidth  / (right - left),
        sh = window.innerHeight / (bottom - top)
  const s = ((sw < sh)? sw : sh)
  const dx = (window.innerWidth  - (right + left) *s)/2,
        dy = (window.innerHeight - (bottom + top) *s)/2

  for (let i = 0; i < Tiles.length; i++) { const tile = Tiles[i]
                                           tile.scale(s); tile.moveBy(dx, dy) }

  const layoutRatio = (right - left) / (bottom - top)
  return layoutRatio
}

function placeTiles( Batches ) {
  const t0 = Tiles[0]
  t0.moveTo(0, 0)

  var i = 1, isLeft = true, isTop = true,
      l = 0, t = 0, r = t0.w, b = t0.h

  for (let k = 2; k <= Batches.length; k++) {
    if (i >= Tiles.length) break

    let w = 0, h = 0, x, y
    const i1 = (k < Batches.length)? Batches[k].i : Tiles.length
    if (Batches[k -1].isAcross) {
      for (let j = i; j < i1; j++) w += Tiles[j].w / Tiles[j].h
      h = (r - l) / w
      x = l
      if (isTop = !isTop&&0) y = (t -= h)
      else             { y = b; b += h }
 
      while (i < i1) {
        const tile = Tiles[i++]
        tile.moveTo(x, y)
        tile.setHeight(h)
        x += tile.w
      }
    }
    else {
      for (let j = i; j < i1; j++) h += Tiles[j].h / Tiles[j].w
      w = (b - t) / h
      y = t
      if (isLeft = !isLeft&&0) x = (l -= w)
      else               { x = r; r += w }
 
      while (i < i1) {
        const tile = Tiles[i++]
        tile.moveTo(x, y)
        tile.setWidth(w)
        y += tile.h
      }
    }
  }
}

var canModify = true
function setRectangularLayout( frameRatio ) {
  var W = Tiles[0].w,
      H = Tiles[0].h,
      Batches = [{ i: 0, isAcross: null, w: 0, h: 0 }]
  
  var i = 1, isAcross, throttle = 1
  while (i < Tiles.length) {
    // throttle placements
    throttle = throttle *1.25 +1

    var w = Tiles[i].w,
        h = Tiles[i].h,
        aspectRatio = W / H

    const s = hardshrink(aspectRatio - frameRatio)
    isAcross = s > 0 || s == 0 && !isAcross
    Batches.push({ i: i, isAcross: isAcross, w: W, h: H })

    if (isAcross) { // place across
      aspectRatio = H / W + h / w //= 1/(W / (W * h / w + H))
      if (hardshrink(aspectRatio - 1/frameRatio) <= 0) i += 1
      else {
        while ((i += 1) < Tiles.length && i < throttle) {
          const dw = h * Tiles[i].w / Tiles[i].h
          aspectRatio = H / W + h / (w + dw) //= 1/(W / (W * h / (w + dw) + H))
          if (hardshrink(aspectRatio - 1/frameRatio) < 0) break
          w += dw
        }
      }
      H += h * W / w
    }
    else { // place downward
      aspectRatio = W / H + w / h //= (W + H * w / h) / H
      if (hardshrink(aspectRatio - frameRatio) <= 0) i += 1
      else {
        while ((i += 1) < Tiles.length && i < throttle) {
          const dh = w * Tiles[i].h / Tiles[i].w
          aspectRatio = W / H + w / (h + dh) //= (W + H * w / (h + dh)) / H
          if (hardshrink(aspectRatio - frameRatio) < 0) break
          h += dh
        }
      }
      W += w * H / h
    }

    if (i >= Tiles.length && canModify) {
      aspectRatio = W / H
      while (Batches.length > 1) {
        const batch = Batches[Batches.length -2]
        let modifiedRatio
        if (batch.isAcross) {
          let r = 0; for (let j = batch.i; j < Tiles.length; j++) r += Tiles[j].w / Tiles[j].h
          modifiedRatio = batch.w / (batch.h + batch.w / r)
        }
        else {
          let r = 0; for (let j = batch.i; j < Tiles.length; j++) r += Tiles[j].h / Tiles[j].w
          modifiedRatio = (batch.w + batch.h / r) / batch.h
        }
        const isModifiedWorse = Math.abs(  aspectRatio - frameRatio) <
                                Math.abs(modifiedRatio - frameRatio)
        if (isModifiedWorse) break
        Batches.pop()
        aspectRatio = modifiedRatio
      }

      break
    }
  }

  placeTiles(Batches)
}

function refresh() {
  for (let k in settings) {
    const input = document.getElementById(k)
    if (input) input.value = settings[k]
  }

  const obj = document.getElementById("settings")
  while (obj.nextSibling) obj.nextSibling.remove()
  Tiles = undefined

  generateTiles()
  update()
}

function update() {
  const frameRatio = window.innerWidth / window.innerHeight
  setRectangularLayout(frameRatio)

  const layoutRatio = centerTiles()
  const ratioError = Math.abs(frameRatio / layoutRatio -1)
  document.title = `Ratio Error: ${round(ratioError, 3)}`
console.log("frame", frameRatio, "layout", layoutRatio, "error", ratioError)
}

function setParams() {
  for (let k in settings) {
    const input = document.getElementById(k)
    if (input && RegExp(`^${input.pattern}\$`).test(input.value)) settings[k] = input.value
  }
  event.target.blur()

  refresh()
}

</script>
<style>

body {
  margin: 0;
  padding: 0;

  overflow: hidden;
}

div {
  position: absolute;
  opacity: 0.5;
}

#settings {
  border: 1px solid black;
  background-color: white;

  left: 0;
  top: 0;
  z-index: 1;
  width: 12px;
  height: 18px;
  overflow: hidden;

  padding: 2px;
}
#settings span {
  font-size: 18px;
}

#settings:hover {
  opacity: 0.9;

  width: auto;
  height: auto;

  padding: 12px;
}
#settings:hover span {
  display: none;
}


.label {
  margin: 5px;
  color: white;
  font-size: 10px;
}

</style>
</head>
<body onload="refresh()" onresize="update()" onclick="update()" onkeypress="onenter(refresh)">
<div id="settings" onkeypress="onenter(setParams)">
<span>?&nbsp;</span>
Resize window or click to update layout.
<br><br>
number of rectangles: <input type="text" id="N" size="4" pattern="[0-9]+" title="Integer">
&nbsp;
<button onclick="refresh()">regenerate</button>
<br>
min-ratio: <input type="text" id="minRatio" size="6" pattern="[0-9/.]+" title="Number or Fraction">
max-ratio: <input type="text" id="maxRatio" size="6" pattern="[0-9/.]+" title="Number or Fraction">
</div>
</body>
</html>
